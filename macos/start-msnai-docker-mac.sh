#!/bin/bash
# start-msnai-docker-mac.sh - Docker Startup Script for MSN-AI - macOS
# Version: 1.0.0
# Author: Alan Mac-Arthur Garc√≠a D√≠az
# Email: alan.mac.arthur.garcia.diaz@gmail.com
# License: GNU General Public License v3.0
# Description: Docker-based startup for MSN-AI on macOS with intelligent setup

echo "üê≥ MSN-AI v1.0.0 - Docker Edition (macOS)"
echo "=========================================="
echo "üìß Desarrollado por: Alan Mac-Arthur Garc√≠a D√≠az"
echo "‚öñÔ∏è Licencia: GPL-3.0 | üîó alan.mac.arthur.garcia.diaz@gmail.com"
echo "üê≥ Modo: Docker Container"
echo "üçé Plataforma: macOS"
echo "üê≥ Modo: Docker Container (Sin Firewall)"
echo "=================================="

# Detect and change to project root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "üîç Detectando directorio del proyecto..."
echo "   Script ubicado en: $SCRIPT_DIR"
echo "   Directorio ra√≠z: $PROJECT_ROOT"

# Change to project root
cd "$PROJECT_ROOT" || {
    echo "‚ùå Error: No se pudo cambiar al directorio del proyecto"
    echo "   Ruta intentada: $PROJECT_ROOT"
    exit 1
}

echo "   Directorio actual: $(pwd)"

# Verify we're in the correct directory
if [ ! -f "msn-ai.html" ]; then
    echo "‚ùå Error: No se encuentra msn-ai.html en $(pwd)"
    echo "   Archivos encontrados:"
    ls -la | head -10
    echo ""
    echo "üí° Aseg√∫rate de ejecutar este script desde:"
    echo "   $PROJECT_ROOT/macos/start-msnai-docker-mac.sh"
    exit 1
fi

echo "‚úÖ Proyecto MSN-AI detectado correctamente"
echo ""

# Check if docker directory exists
if [ ! -d "docker" ]; then
    echo "‚ùå Error: Directorio docker no encontrado"
    echo "   Aseg√∫rate de que todos los archivos Docker est√©n presentes"
    exit 1
fi

# Function to detect macOS version and architecture
detect_mac_info() {
    echo "üçé Detectando informaci√≥n del sistema..."

    MAC_VERSION=$(sw_vers -productVersion)
    MAC_ARCH=$(uname -m)

    echo "‚úÖ macOS: $MAC_VERSION"
    echo "‚úÖ Arquitectura: $MAC_ARCH"

    if [[ "$MAC_ARCH" == "arm64" ]]; then
        echo "üöÄ Apple Silicon (M1/M2/M3) detectado - Excelente para IA!"
        USE_APPLE_SILICON=true
    else
        echo "‚ö° Intel Mac detectado"
        USE_APPLE_SILICON=false
    fi
}

# Function to check disk space
check_disk_space() {
    echo "üîç Verificando espacio en disco..."

    # Get available space in /var (where Docker Desktop stores data on macOS)
    local docker_dir="/"
    if [ -d "$HOME/Library/Containers/com.docker.docker/Data" ]; then
        docker_dir="$HOME/Library/Containers/com.docker.docker/Data"
    fi

    local available_gb=$(df -g "$docker_dir" | awk 'NR==2 {print $4}')
    local required_gb=5  # Minimum 5GB required for Ollama and MSN-AI images

    echo "   Espacio disponible: ${available_gb}GB"
    echo "   Espacio requerido: ${required_gb}GB"

    if [ "$available_gb" -lt "$required_gb" ]; then
        echo ""
        echo "‚ùå ERROR: Espacio en disco insuficiente"
        echo "   Disponible: ${available_gb}GB"
        echo "   Requerido: ${required_gb}GB m√≠nimo"
        echo ""
        echo "üí° Soluciones:"
        echo "   1. Libera espacio en disco eliminando archivos innecesarios"
        echo "   2. Limpia im√°genes Docker antiguas:"
        echo "      docker system prune -a --volumes"
        echo "   3. Aumenta el espacio del disco/partici√≥n"
        echo "   4. Vac√≠a la papelera de macOS"
        echo ""
        echo "üìä Uso actual del disco:"
        df -h "$docker_dir" | head -2
        echo ""

        read -p "¬øDeseas continuar de todas formas? (s/N): " continue_anyway
        if [[ ! "$continue_anyway" =~ ^[sS]$ ]]; then
            echo "‚ùå Instalaci√≥n cancelada por falta de espacio"
            exit 1
        fi
        echo "‚ö†Ô∏è  Continuando con espacio limitado (puede fallar)..."
    else
        echo "‚úÖ Espacio en disco suficiente: ${available_gb}GB disponible"
    fi
    echo ""
}

# Function to check Docker installation
check_docker() {
    echo "üîç Verificando Docker..."

    # Check disk space first
    check_disk_space

    if ! command -v docker &> /dev/null; then
        echo "‚ùå Docker no est√° instalado"
        echo ""
        echo "üöÄ Opciones de instalaci√≥n:"
        echo "   1. Instalar Docker Desktop autom√°ticamente (recomendado)"
        echo "   2. Instalar via Homebrew"
        echo "   3. Instrucciones manuales"
        echo "   4. Continuar sin Docker (modo local)"

        read -p "Selecciona una opci√≥n (1-4): " docker_option

        case $docker_option in
            1)
                install_docker_desktop
                ;;
            2)
                install_docker_homebrew
                ;;
            3)
                show_docker_instructions
                exit 1
                ;;
            4)
                echo "üîÑ Iniciando en modo local..."
                exec ./start-msnai-mac.sh "$@"
                ;;
            *)
                echo "‚ùå Opci√≥n no v√°lida"
                exit 1
                ;;
        esac
    else
        echo "‚úÖ Docker instalado: $(docker --version | cut -d' ' -f3)"
    fi

    # Check if Docker is running
    if ! docker info >/dev/null 2>&1; then
        echo "‚ùå Docker no est√° ejecut√°ndose"
        echo "   Inicia Docker Desktop desde Applications"
        echo "   O ejecuta: open -a Docker"
        exit 1
    else
        echo "‚úÖ Docker est√° ejecut√°ndose"
    fi

    # Check Docker Compose
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        echo "‚ùå Docker Compose no est√° disponible"
        echo "   Docker Desktop incluye Docker Compose autom√°ticamente"
        exit 1
    else
        echo "‚úÖ Docker Compose disponible"
    fi
}

# Function to install Docker Desktop
install_docker_desktop() {
    echo "üì¶ Instalando Docker Desktop..."

    # Detect architecture for correct download
    if [[ "$USE_APPLE_SILICON" == true ]]; then
        DOCKER_URL="https://desktop.docker.com/mac/main/arm64/Docker.dmg"
        echo "üì• Descargando Docker Desktop para Apple Silicon..."
    else
        DOCKER_URL="https://desktop.docker.com/mac/main/amd64/Docker.dmg"
        echo "üì• Descargando Docker Desktop para Intel Mac..."
    fi

    # Download Docker Desktop
    echo "‚è¨ Descargando desde: $DOCKER_URL"
    curl -L -o /tmp/Docker.dmg "$DOCKER_URL"

    if [ $? -eq 0 ]; then
        echo "‚úÖ Descarga completada"

        # Mount and install
        echo "üìÄ Montando imagen..."
        hdiutil attach /tmp/Docker.dmg -quiet

        echo "üì¶ Instalando Docker Desktop..."
        cp -R "/Volumes/Docker/Docker.app" "/Applications/"

        # Unmount
        hdiutil detach "/Volumes/Docker" -quiet

        # Clean up
        rm /tmp/Docker.dmg

        echo "‚úÖ Docker Desktop instalado en /Applications/"
        echo "üöÄ Iniciando Docker Desktop..."
        open -a Docker

        echo "‚è≥ Esperando que Docker Desktop se inicie..."
        sleep 10

        # Wait for Docker to be ready
        local max_attempts=30
        local attempt=1

        while [ $attempt -le $max_attempts ]; do
            if docker info >/dev/null 2>&1; then
                echo "‚úÖ Docker Desktop iniciado correctamente"
                break
            fi

            echo "‚è≥ Esperando Docker... (intento $attempt/$max_attempts)"
            sleep 5
            attempt=$((attempt + 1))
        done

        if [ $attempt -gt $max_attempts ]; then
            echo "‚ö†Ô∏è Docker Desktop tarda en iniciar"
            echo "   Inicia manualmente Docker Desktop desde Applications"
            exit 1
        fi
    else
        echo "‚ùå Error descargando Docker Desktop"
        exit 1
    fi
}

# Function to install Docker via Homebrew
install_docker_homebrew() {
    echo "üç∫ Instalando Docker via Homebrew..."

    # Check if Homebrew is installed
    if ! command -v brew &> /dev/null; then
        echo "üì¶ Homebrew no est√° instalado, instalando..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for current session
        if [[ "$USE_APPLE_SILICON" == true ]]; then
            export PATH="/opt/homebrew/bin:$PATH"
        else
            export PATH="/usr/local/bin:$PATH"
        fi
    fi

    echo "üì¶ Instalando Docker Desktop con Homebrew..."
    brew install --cask docker

    if [ $? -eq 0 ]; then
        echo "‚úÖ Docker Desktop instalado via Homebrew"
        echo "üöÄ Iniciando Docker Desktop..."
        open -a Docker

        # Wait for Docker to be ready
        echo "‚è≥ Esperando que Docker Desktop se inicie..."
        sleep 15

        local max_attempts=20
        local attempt=1

        while [ $attempt -le $max_attempts ]; do
            if docker info >/dev/null 2>&1; then
                echo "‚úÖ Docker Desktop iniciado correctamente"
                break
            fi

            echo "‚è≥ Esperando Docker... (intento $attempt/$max_attempts)"
            sleep 5
            attempt=$((attempt + 1))
        done
    else
        echo "‚ùå Error instalando Docker via Homebrew"
        exit 1
    fi
}

# Function to show manual Docker installation instructions
show_docker_instructions() {
    echo ""
    echo "üìñ Instrucciones de instalaci√≥n manual de Docker:"
    echo "================================================="
    echo ""
    echo "üçé macOS (Apple Silicon M1/M2/M3):"
    echo "   1. Descarga: https://desktop.docker.com/mac/main/arm64/Docker.dmg"
    echo "   2. Arrastra Docker.app a Applications"
    echo "   3. Inicia Docker desde Applications"
    echo ""
    echo "üçé macOS (Intel):"
    echo "   1. Descarga: https://desktop.docker.com/mac/main/amd64/Docker.dmg"
    echo "   2. Arrastra Docker.app a Applications"
    echo "   3. Inicia Docker desde Applications"
    echo ""
    echo "üç∫ Alternativa con Homebrew:"
    echo "   brew install --cask docker"
    echo ""
    echo "üí° Despu√©s de instalar, ejecuta este script nuevamente"
}

# Function to check hardware optimization
check_hardware_optimization() {
    echo "üîß Optimizando configuraci√≥n para hardware..."

    if [[ "$USE_APPLE_SILICON" == true ]]; then
        echo "üöÄ Configuraci√≥n Apple Silicon:"
        echo "   ‚úÖ Rendimiento optimizado para ARM64"
        echo "   ‚úÖ Memoria unificada disponible"
        echo "   ‚úÖ Neural Engine para IA (si es compatible)"

        # Check memory
        TOTAL_MEMORY=$(sysctl -n hw.memsize)
        MEMORY_GB=$((TOTAL_MEMORY / 1024 / 1024 / 1024))
        echo "   üíæ Memoria total: ${MEMORY_GB}GB"

        if [ "$MEMORY_GB" -ge 16 ]; then
            echo "   ‚úÖ Memoria suficiente para modelos avanzados"
            RECOMMENDED_MODEL="mistral:7b"
        else
            echo "   ‚ö†Ô∏è Memoria limitada, usando modelo ligero"
            RECOMMENDED_MODEL="phi3:mini"
        fi
    else
        echo "‚ö° Configuraci√≥n Intel Mac:"

        # Check memory
        TOTAL_MEMORY=$(sysctl -n hw.memsize)
        MEMORY_GB=$((TOTAL_MEMORY / 1024 / 1024 / 1024))
        echo "   üíæ Memoria total: ${MEMORY_GB}GB"

        if [ "$MEMORY_GB" -ge 32 ]; then
            RECOMMENDED_MODEL="mistral:7b"
            echo "   ‚úÖ Memoria suficiente para modelo est√°ndar"
        elif [ "$MEMORY_GB" -ge 16 ]; then
            RECOMMENDED_MODEL="phi3:mini"
            echo "   ‚ö†Ô∏è Memoria media, usando modelo ligero"
        else
            RECOMMENDED_MODEL="tinyllama"
            echo "   ‚ö†Ô∏è Memoria limitada, usando modelo b√°sico"
        fi
    fi

    echo "   ü§ñ Modelo recomendado: $RECOMMENDED_MODEL"
}

# Function to setup environment
setup_environment() {
    echo "‚öôÔ∏è Configurando entorno Docker..."

    # Create .env file for Docker Compose
    cat > .env << EOF
# MSN-AI Docker Environment Configuration
MSN_AI_VERSION=1.0.0
MSN_AI_PORT=8000
COMPOSE_PROJECT_NAME=msn-ai
DOCKER_BUILDKIT=1
RECOMMENDED_MODEL=$RECOMMENDED_MODEL
APPLE_SILICON=$USE_APPLE_SILICON
MEMORY_GB=$MEMORY_GB
EOF

    echo "‚úÖ Archivo de entorno creado"
}

# Function to build and start containers
start_containers() {
    echo "üèóÔ∏è Construyendo e iniciando contenedores..."

    # Build images
    echo "üì¶ Construyendo imagen MSN-AI..."
    docker-compose -f docker/docker-compose.yml build --no-cache

    if [ $? -ne 0 ]; then
        echo "‚ùå Error construyendo la imagen"
        exit 1
    fi

    # Start services
    echo "üöÄ Iniciando servicios..."
    docker-compose -f docker/docker-compose.yml up -d

    if [ $? -ne 0 ]; then
        echo "‚ùå Error iniciando los servicios"
        exit 1
    fi

    echo "‚úÖ Contenedores iniciados correctamente"
}

# Function to wait for services
wait_for_services() {
    echo "‚è≥ Esperando que los servicios est√©n listos..."

    local max_attempts=30
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if curl -s http://localhost:8000/msn-ai.html >/dev/null 2>&1; then
            echo "‚úÖ MSN-AI est√° listo"
            break
        fi

        echo "‚è≥ Intento $attempt/$max_attempts..."
        sleep 2
        attempt=$((attempt + 1))
    done

    if [ $attempt -gt $max_attempts ]; then
        echo "‚ö†Ô∏è Timeout esperando los servicios"
        echo "   Verifica los logs: docker-compose -f docker/docker-compose.yml logs"
    fi
}

# Function to open application
open_application() {
    echo "üåê Abriendo MSN-AI en el navegador..."

    # Try Safari first (native macOS), then other browsers
    if [ -d "/Applications/Safari.app" ]; then
        open -a Safari http://localhost:8000/msn-ai.html
    elif [ -d "/Applications/Google Chrome.app" ]; then
        open -a "Google Chrome" http://localhost:8000/msn-ai.html
    elif [ -d "/Applications/Firefox.app" ]; then
        open -a Firefox http://localhost:8000/msn-ai.html
    else
        # Use default browser
        open http://localhost:8000/msn-ai.html
    fi
}

# Function to show status and logs
show_status() {
    echo ""
    echo "üéâ ¬°MSN-AI Docker est√° ejecut√°ndose en macOS!"
    echo "============================================="
    echo "üì± URL: http://localhost:8000/msn-ai.html"
    echo "üçé Sistema: macOS $MAC_VERSION ($MAC_ARCH)"
    echo "üíæ Memoria: ${MEMORY_GB}GB"
    echo "ü§ñ Modelo recomendado: $RECOMMENDED_MODEL"
    echo ""
    echo "üê≥ Contenedores:"
    docker-compose -f docker/docker-compose.yml ps
    echo ""
    echo "üí° Comandos √∫tiles:"
    echo "   üîç Ver logs:        docker-compose -f docker/docker-compose.yml logs -f"
    echo "   ‚èπÔ∏è Detener:         docker-compose -f docker/docker-compose.yml down"
    echo "   üîÑ Reiniciar:       docker-compose -f docker/docker-compose.yml restart"
    echo "   üìä Estado:          docker-compose -f docker/docker-compose.yml ps"
    echo ""
    echo "‚ö†Ô∏è DETENCI√ìN CORRECTA:"
    echo "   docker-compose -f docker/docker-compose.yml down"
    echo ""
    echo "üí° Optimizaciones macOS:"
    if [[ "$USE_APPLE_SILICON" == true ]]; then
        echo "   üöÄ Ejecut√°ndose con optimizaci√≥n Apple Silicon"
        echo "   ‚ö° Rendimiento mejorado para ARM64"
    else
        echo "   ‚ö° Ejecut√°ndose en Intel Mac"
    fi
    echo ""
    echo "üîß Datos persistentes en volumes de Docker"
    echo "üìß Soporte: alan.mac.arthur.garcia.diaz@gmail.com"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "‚òÅÔ∏è  MODELOS CLOUD DISPONIBLES"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "Los siguientes modelos cloud requieren autenticaci√≥n:"
    echo "  üì¶ qwen3-vl:235b-cloud"
    echo "  üì¶ gpt-oss:120b-cloud"
    echo "  üì¶ qwen3-coder:480b-cloud"
    echo ""
    echo "‚ö†Ô∏è  Los modelos cloud NO se instalan autom√°ticamente"
    echo ""
    echo "üìã Para instalar modelos cloud:"
    echo ""
    echo "1Ô∏è‚É£  Usa el script helper:"
    echo "   bash macos/docker-install-cloud-models-mac.sh"
    echo ""
    echo "O manualmente:"
    echo "   docker exec -it msn-ai-ollama /bin/bash"
    echo "   ollama signin"
    echo "   ollama pull qwen3-vl:235b-cloud"
    echo "   exit"
    echo ""
    echo "üí° Los modelos locales ya est√°n instalados y funcionando"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
}

# Function for cleanup
cleanup() {
    echo ""
    echo "üßπ Deteniendo contenedores MSN-AI..."
    docker-compose -f docker/docker-compose.yml down
    echo "‚úÖ Contenedores detenidos correctamente"
    echo "üëã ¬°Gracias por usar MSN-AI v1.0.0 en macOS!"
    exit 0
}

# Trap signals for cleanup
trap cleanup SIGINT SIGTERM

# Main execution flow
main() {
    echo "üöÄ Iniciando MSN-AI en modo Docker para macOS..."

    # Detect macOS information
    detect_mac_info

    # Check Docker installation
    check_docker

    # Check hardware optimization
    check_hardware_optimization

    # Setup environment
    setup_environment

    # Start containers
    start_containers

    # Wait for services
    wait_for_services

    # Open application (if not --no-browser flag)
    if [ "$1" != "--no-browser" ]; then
        open_application
    fi

    # Show status
    show_status

    # Keep script running for signal handling
    if [ "$1" = "--daemon" ]; then
        echo "üîÑ Modo daemon activado. Presiona Ctrl+C para detener."
        while true; do
            sleep 1
        done
    else
        echo "üí° Script completado. Los contenedores contin√∫an ejecut√°ndose."
        echo "   Para detenerlos: docker-compose -f docker/docker-compose.yml down"
    fi
}

# Parse command line arguments
case "$1" in
    --help|-h)
        echo "MSN-AI Docker macOS - Opciones de uso:"
        echo ""
        echo "  $0                    Iniciar con navegador autom√°tico"
        echo "  $0 --no-browser      Iniciar sin abrir navegador"
        echo "  $0 --daemon          Mantener script activo"
        echo "  $0 --help            Mostrar esta ayuda"
        echo ""
        echo "üçé Optimizado para macOS (Intel y Apple Silicon)"
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac
