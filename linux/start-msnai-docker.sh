#!/bin/bash
# Docker Startup Script for MSN-AI - Linux
# Version: 2.1.0
# Author: Alan Mac-Arthur Garc√≠a D√≠az
# Email: alan.mac.arthur.garcia.diaz@gmail.com
# License: GNU General Public License v3.0
# Description: Docker-based startup for MSN-AI with intelligent setup

echo "üê≥ MSN-AI v2.1.0 - Docker Edition"
echo "=================================="
echo "üìß Desarrollado por: Alan Mac-Arthur Garc√≠a D√≠az"
echo "‚öñÔ∏è Licencia: GPL-3.0 | üîó alan.mac.arthur.garcia.diaz@gmail.com"
echo "üê≥ Modo: Docker Container (Sin Firewall)"
echo "=================================="

# Detect and change to project root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "üîç Detectando directorio del proyecto..."
echo "   Script ubicado en: $SCRIPT_DIR"
echo "   Directorio ra√≠z: $PROJECT_ROOT"

# Change to project root
cd "$PROJECT_ROOT" || {
    echo "‚ùå Error: No se pudo cambiar al directorio del proyecto"
    echo "   Ruta intentada: $PROJECT_ROOT"
    exit 1
}

echo "   Directorio actual: $(pwd)"

# Verify we're in the correct directory
if [ ! -f "msn-ai.html" ]; then
    echo "‚ùå Error: No se encuentra msn-ai.html en $(pwd)"
    echo "   Archivos encontrados:"
    ls -la | head -10
    echo ""
    echo "üí° Aseg√∫rate de ejecutar este script desde:"
    echo "   $PROJECT_ROOT/linux/start-msnai-docker.sh"
    exit 1
fi

echo "‚úÖ Proyecto MSN-AI detectado correctamente"
echo ""

# Check if docker directory exists
if [ ! -d "docker" ]; then
    echo "‚ùå Error: Directorio docker no encontrado"
    echo "   Aseg√∫rate de que todos los archivos Docker est√©n presentes"
    exit 1
fi

# Function to detect and configure Docker Compose
setup_docker_compose() {
    echo "üîç Detectando Docker Compose..."

    # Check if docker-compose (standalone binary) exists
    if command -v docker-compose &> /dev/null; then
        DOCKER_COMPOSE_CMD="docker-compose"
        echo "‚úÖ Docker Compose (standalone) disponible"
        return 0
    fi

    # Check if docker compose (plugin) exists
    if docker compose version &> /dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker compose"
        echo "‚úÖ Docker Compose (plugin) disponible"
        return 0
    fi

    # Neither available, offer installation
    echo "‚ùå Docker Compose no est√° disponible"
    echo ""
    echo "üöÄ Opciones:"
    echo "   1. Instalar docker-compose standalone (recomendado para compatibilidad)"
    echo "   2. Usar docker compose plugin (requiere Docker Engine reciente)"
    echo "   3. Salir e instalar manualmente"

    read -p "Selecciona una opci√≥n (1-3): " compose_option

    case $compose_option in
        1)
            install_docker_compose_standalone
            ;;
        2)
            if docker compose version &> /dev/null 2>&1; then
                DOCKER_COMPOSE_CMD="docker compose"
                echo "‚úÖ Usando docker compose plugin"
            else
                echo "‚ùå Docker compose plugin no disponible"
                echo "   Actualiza Docker Engine o instala Docker Desktop"
                exit 1
            fi
            ;;
        3)
            echo "‚ÑπÔ∏è  Para instalar manualmente:"
            echo "   curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose"
            echo "   sudo chmod +x /usr/local/bin/docker-compose"
            exit 1
            ;;
        *)
            echo "‚ùå Opci√≥n no v√°lida"
            exit 1
            ;;
    esac
}

# Function to install docker-compose standalone
install_docker_compose_standalone() {
    echo "üì¶ Instalando docker-compose standalone..."

    # Detect architecture
    ARCH=$(uname -m)
    case $ARCH in
        x86_64)
            COMPOSE_URL="https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64"
            ;;
        aarch64|arm64)
            COMPOSE_URL="https://github.com/docker/compose/releases/latest/download/docker-compose-linux-aarch64"
            ;;
        *)
            echo "‚ùå Arquitectura $ARCH no soportada para instalaci√≥n autom√°tica"
            exit 1
            ;;
    esac

    # Check if we can write to /usr/local/bin
    if [ -w "/usr/local/bin" ]; then
        INSTALL_PATH="/usr/local/bin/docker-compose"
        SUDO_CMD=""
    else
        INSTALL_PATH="/usr/local/bin/docker-compose"
        SUDO_CMD="sudo"
        echo "üîê Se requieren permisos de administrador para instalar en /usr/local/bin"
    fi

    # Download and install
    echo "üì• Descargando desde: $COMPOSE_URL"
    if curl -SL "$COMPOSE_URL" -o "/tmp/docker-compose" 2>/dev/null; then
        $SUDO_CMD mv "/tmp/docker-compose" "$INSTALL_PATH"
        $SUDO_CMD chmod +x "$INSTALL_PATH"

        # Verify installation
        if command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE_CMD="docker-compose"
            echo "‚úÖ Docker Compose standalone instalado correctamente"
            echo "   Versi√≥n: $(docker-compose --version)"
        else
            echo "‚ùå Error en la instalaci√≥n"
            exit 1
        fi
    else
        echo "‚ùå Error descargando docker-compose"
        exit 1
    fi
}

# Function to check disk space
check_disk_space() {
    echo "üîç Verificando espacio en disco..."

    # Get available space in /var/lib/docker (where Docker stores images)
    local docker_dir="/var/lib/docker"
    if [ ! -d "$docker_dir" ]; then
        docker_dir="/"
    fi

    local available_gb=$(df -BG "$docker_dir" | awk 'NR==2 {print $4}' | sed 's/G//')
    local required_gb=5  # Minimum 5GB required for Ollama and MSN-AI images

    echo "   Espacio disponible: ${available_gb}GB"
    echo "   Espacio requerido: ${required_gb}GB"

    if [ "$available_gb" -lt "$required_gb" ]; then
        echo ""
        echo "‚ùå ERROR: Espacio en disco insuficiente"
        echo "   Disponible: ${available_gb}GB"
        echo "   Requerido: ${required_gb}GB m√≠nimo"
        echo ""
        echo "üí° Soluciones:"
        echo "   1. Libera espacio en disco eliminando archivos innecesarios"
        echo "   2. Limpia im√°genes Docker antiguas:"
        echo "      docker system prune -a --volumes"
        echo "   3. Aumenta el espacio del disco/partici√≥n"
        echo ""
        echo "üìä Uso actual del disco:"
        df -h "$docker_dir" | head -2
        echo ""

        read -p "¬øDeseas continuar de todas formas? (s/N): " continue_anyway
        if [[ ! "$continue_anyway" =~ ^[sS]$ ]]; then
            echo "‚ùå Instalaci√≥n cancelada por falta de espacio"
            exit 1
        fi
        echo "‚ö†Ô∏è  Continuando con espacio limitado (puede fallar)..."
    else
        echo "‚úÖ Espacio en disco suficiente: ${available_gb}GB disponible"
    fi
    echo ""
}

# Function to check Docker installation
check_docker() {
    echo "üîç Verificando Docker..."

    # Check disk space first
    check_disk_space

    if ! command -v docker &> /dev/null; then
        echo "‚ùå Docker no est√° instalado"
        echo ""
        echo "üöÄ Opciones de instalaci√≥n:"
        echo "   1. Instalar autom√°ticamente (recomendado)"
        echo "   2. Instrucciones manuales"
        echo "   3. Continuar sin Docker (modo local)"

        read -p "Selecciona una opci√≥n (1-3): " docker_option

        case $docker_option in
            1)
                install_docker
                ;;
            2)
                show_docker_instructions
                exit 1
                ;;
            3)
                echo "üîÑ Iniciando en modo local..."
                exec ./start-msnai.sh "$@"
                ;;
            *)
                echo "‚ùå Opci√≥n no v√°lida"
                exit 1
                ;;
        esac
    else
        echo "‚úÖ Docker instalado: $(docker --version | cut -d' ' -f3)"
    fi

    # Check if Docker is running
    if ! docker info >/dev/null 2>&1; then
        echo "‚ùå Docker no est√° ejecut√°ndose"
        echo "   Ejecuta: sudo systemctl start docker"
        echo "   O inicia Docker Desktop si lo usas"
        exit 1
    else
        echo "‚úÖ Docker est√° ejecut√°ndose"
    fi

    # Setup Docker Compose
    setup_docker_compose
}

# Function to install Docker automatically
install_docker() {
    echo "üì¶ Instalando Docker autom√°ticamente..."

    # Detect Linux distribution
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
    else
        echo "‚ùå No se pudo detectar la distribuci√≥n Linux"
        exit 1
    fi

    case $DISTRO in
        ubuntu|debian)
            echo "üêß Detectado: $PRETTY_NAME"
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            rm get-docker.sh
            ;;
        centos|rhel|fedora)
            echo "üé© Detectado: $PRETTY_NAME"
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl start docker
            sudo systemctl enable docker
            rm get-docker.sh
            ;;
        arch)
            echo "üèπ Detectado: Arch Linux"
            sudo pacman -S docker
            sudo usermod -aG docker $USER
            sudo systemctl start docker
            sudo systemctl enable docker
            ;;
        *)
            echo "‚ö†Ô∏è  Distribuci√≥n no soportada para instalaci√≥n autom√°tica: $DISTRO"
            show_docker_instructions
            exit 1
            ;;
    esac

    echo "‚úÖ Docker instalado correctamente"
    echo "‚ö†Ô∏è  Es necesario reiniciar la sesi√≥n para aplicar los permisos"
    echo "   Ejecuta: newgrp docker"
    echo "   O cierra sesi√≥n e inicia sesi√≥n nuevamente"
}

# Function to show manual Docker installation instructions
show_docker_instructions() {
    echo ""
    echo "üìñ Instrucciones de instalaci√≥n manual de Docker:"
    echo "================================================="
    echo ""
    echo "üêß Ubuntu/Debian:"
    echo "   curl -fsSL https://get.docker.com -o get-docker.sh"
    echo "   sudo sh get-docker.sh"
    echo "   sudo usermod -aG docker \$USER"
    echo ""
    echo "üé© CentOS/RHEL/Fedora:"
    echo "   sudo yum install -y docker"
    echo "   sudo systemctl start docker"
    echo "   sudo usermod -aG docker \$USER"
    echo ""
    echo "üèπ Arch Linux:"
    echo "   sudo pacman -S docker"
    echo "   sudo systemctl start docker"
    echo "   sudo usermod -aG docker \$USER"
    echo ""
    echo "üí° Despu√©s de instalar, ejecuta este script nuevamente"
}

# Function to check hardware for GPU support
check_gpu_support() {
    echo "üéÆ Verificando soporte de GPU..."

    if command -v nvidia-smi &> /dev/null; then
        echo "‚úÖ NVIDIA GPU detectada"

        # Check NVIDIA Container Toolkit
        if docker run --rm --gpus all nvidia/cuda:11.8-base-ubuntu22.04 nvidia-smi &> /dev/null; then
            echo "‚úÖ NVIDIA Container Toolkit configurado"
            USE_GPU=true
        else
            echo "‚ö†Ô∏è  NVIDIA Container Toolkit no disponible"
            echo "   Para habilitar GPU en Docker, instala:"
            echo "   https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html"
            USE_GPU=false
        fi
    else
        echo "‚ÑπÔ∏è  GPU NVIDIA no detectada, usando solo CPU"
        USE_GPU=false
    fi
}

# Function to check port conflicts
check_port_conflicts() {
    echo "üîç Verificando conflictos de puerto..."

    local conflicts_found=false

    # Check port 8000
    if netstat -tuln 2>/dev/null | grep -q ":8000 " || ss -tuln 2>/dev/null | grep -q ":8000 "; then
        echo "‚ö†Ô∏è  Puerto 8000 ya est√° en uso:"
        netstat -tulnp 2>/dev/null | grep ":8000 " || ss -tulnp 2>/dev/null | grep ":8000 " || true
        conflicts_found=true
    fi

    # Check port 11434
    if netstat -tuln 2>/dev/null | grep -q ":11434 " || ss -tuln 2>/dev/null | grep -q ":11434 "; then
        echo "‚ö†Ô∏è  Puerto 11434 ya est√° en uso (posiblemente Ollama local):"
        netstat -tulnp 2>/dev/null | grep ":11434 " || ss -tulnp 2>/dev/null | grep ":11434 " || true
        echo "üí° Para servidor dedicado, det√©n Ollama local:"
        echo "   sudo systemctl stop ollama"
        echo "   sudo pkill -f ollama"
        conflicts_found=true
    fi

    if [ "$conflicts_found" = true ]; then
        echo ""
        echo "‚ùì ¬øContinuar con la instalaci√≥n? Los contenedores pueden fallar si los puertos est√°n ocupados. (y/N):"
        if [ "${AUTO_MODE}" != "true" ]; then
            read -r CONTINUE
            if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
                echo "‚ùå Instalaci√≥n cancelada por el usuario"
                exit 1
            fi
        else
            echo "‚ö†Ô∏è  Modo autom√°tico: Intentando continuar..."
        fi
    else
        echo "‚úÖ Puertos 8000 y 11434 disponibles"
    fi
}

# Function to setup Docker environment
setup_environment() {
    echo "‚öôÔ∏è  Configurando entorno Docker..."

    # Check for existing OLLAMA_API_KEY
    OLLAMA_API_KEY_VALUE=""

    # Check if .env file exists and has API key
    if [ -f ".env" ]; then
        OLLAMA_API_KEY_VALUE=$(grep "^OLLAMA_API_KEY=" .env 2>/dev/null | cut -d'=' -f2-)
    fi

    # If not in .env, check environment
    if [ -z "$OLLAMA_API_KEY_VALUE" ] && [ -n "$OLLAMA_API_KEY" ]; then
        OLLAMA_API_KEY_VALUE="$OLLAMA_API_KEY"
    fi

    # If still not found, prompt user
    if [ -z "$OLLAMA_API_KEY_VALUE" ]; then
        echo ""
        echo "üîë Configuraci√≥n de API Key para modelos cloud"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "‚ö†Ô∏è  Los modelos cloud requieren una API Key:"
        echo "   - qwen3-vl:235b-cloud"
        echo "   - gpt-oss:120b-cloud"
        echo "   - qwen3-coder:480b-cloud"
        echo ""
        echo "üí° Si no tienes una API Key, estos modelos no funcionar√°n"
        echo "   (puedes configurarla despu√©s)"
        echo ""
        read -p "¬øDeseas configurar la API Key ahora? (s/N): " CONFIGURE_API_KEY

        if [[ "$CONFIGURE_API_KEY" =~ ^[sS]$ ]]; then
            echo ""
            read -p "Ingresa tu OLLAMA_API_KEY: " OLLAMA_API_KEY_VALUE

            if [ -n "$OLLAMA_API_KEY_VALUE" ]; then
                echo "‚úÖ API Key configurada"
            else
                echo "‚ö†Ô∏è  No se ingres√≥ API Key, continuando sin ella"
            fi
        else
            echo "‚è≠Ô∏è  Continuando sin API Key"
            echo "   Para configurarla despu√©s, ejecuta:"
            echo "   echo 'OLLAMA_API_KEY=tu_clave_aqui' >> .env"
        fi
        echo ""
    else
        # Mask the key for display
        MASKED_KEY="${OLLAMA_API_KEY_VALUE:0:8}***${OLLAMA_API_KEY_VALUE: -4}"
        echo "‚úÖ API Key encontrada: ${MASKED_KEY}"
    fi

    # Create .env file for Docker Compose
    cat > .env << EOF
# MSN-AI Docker Environment Configuration
MSN_AI_VERSION=1.0.0
MSN_AI_PORT=8000
COMPOSE_PROJECT_NAME=msn-ai
DOCKER_BUILDKIT=1
EOF

    # Add API Key if configured
    if [ -n "$OLLAMA_API_KEY_VALUE" ]; then
        echo "OLLAMA_API_KEY=${OLLAMA_API_KEY_VALUE}" >> .env
        echo "‚úÖ API Key agregada al archivo .env"
    else
        echo "# OLLAMA_API_KEY=your_api_key_here" >> .env
    fi

    # Add GPU configuration if available
    if [ "$USE_GPU" = true ]; then
        echo "GPU_SUPPORT=true" >> .env
    else
        echo "GPU_SUPPORT=false" >> .env
    fi

    echo "‚úÖ Archivo de entorno creado"
}

# Function to build and start containers
start_containers() {
    echo "üèóÔ∏è  Construyendo e iniciando contenedores..."
    echo ""

    # Create build log directory
    BUILD_LOG_DIR="$PROJECT_ROOT/docker/logs"
    mkdir -p "$BUILD_LOG_DIR"
    BUILD_LOG="$BUILD_LOG_DIR/build_$(date +%Y%m%d_%H%M%S).log"

    echo "üìù Los logs se guardar√°n en: $BUILD_LOG"
    echo ""

    # Check disk space before build
    echo "üîç Verificando espacio antes de construir..."
    local available_gb=$(df -BG /var/lib/docker 2>/dev/null || df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
    echo "   Espacio disponible: ${available_gb}GB"

    if [ "$available_gb" -lt 3 ]; then
        echo ""
        echo "‚ö†Ô∏è  ADVERTENCIA: Espacio muy limitado (${available_gb}GB)"
        echo "   La construcci√≥n puede fallar por falta de espacio"
        echo ""
        read -p "¬øContinuar de todas formas? (s/N): " continue_build
        if [[ ! "$continue_build" =~ ^[sS]$ ]]; then
            echo "‚ùå Construcci√≥n cancelada"
            exit 1
        fi
    fi
    echo ""

    # Build images with verbose output
    echo "üì¶ Construyendo imagen MSN-AI..."
    echo "   Esto puede tardar varios minutos en la primera ejecuci√≥n..."
    echo "   Comando: $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml build --no-cache"
    echo ""

    # Run build with full output
    if $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml build --no-cache --progress=plain 2>&1 | tee "$BUILD_LOG"; then
        echo ""
        echo "‚úÖ Imagen construida exitosamente"
    else
        BUILD_EXIT_CODE=$?
        echo ""
        echo "‚ùå Error construyendo la imagen (c√≥digo de salida: $BUILD_EXIT_CODE)"
        echo "üìù Revisa los logs en: $BUILD_LOG"
        echo ""
        echo "üí° Diagn√≥stico r√°pido:"
        echo ""
        echo "üìä Espacio en disco:"
        df -h /var/lib/docker 2>/dev/null || df -h /
        echo ""
        echo "üíæ Memoria disponible:"
        free -h
        echo ""
        echo "üìù √öltimos errores del log:"
        tail -30 "$BUILD_LOG"
        echo ""
        echo "üîç Para diagn√≥stico completo, ejecuta:"
        echo "   bash linux/docker-diagnostics.sh"
        exit 1
    fi

    echo ""

    # Start services with verbose output
    echo "üöÄ Iniciando servicios..."
    echo "   Comando: $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml up -d"
    echo ""

    # Create startup log
    STARTUP_LOG="$BUILD_LOG_DIR/startup_$(date +%Y%m%d_%H%M%S).log"

    if $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml up -d 2>&1 | tee "$STARTUP_LOG"; then
        echo ""
        echo "‚úÖ Servicios iniciados"
        echo ""

        # Show container status
        echo "üìä Estado de los contenedores:"
        $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps
        echo ""

        # Check if ai-setup failed (non-critical)
        if docker ps -a --format '{{.Names}} {{.Status}}' | grep -q "msn-ai-setup.*Exited"; then
            echo "‚ÑπÔ∏è  NOTA: El servicio ai-setup finaliz√≥ (esto es normal)"
            echo "   Este servicio configura modelos de IA autom√°ticamente"
            echo "   Los modelos pueden instalarse manualmente desde la interfaz"
            echo ""
        fi
    else
        STARTUP_EXIT_CODE=$?
        echo ""
        echo "‚ùå Error iniciando los servicios (c√≥digo de salida: $STARTUP_EXIT_CODE)"
        echo "üìù Revisa los logs en: $STARTUP_LOG"
        echo ""
        echo "üìä Diagn√≥stico del sistema:"
        echo "Espacio en disco:"
        df -h /var/lib/docker 2>/dev/null || df -h /
        echo ""
        echo "üí° Mostrando logs recientes de los contenedores:"
        echo ""
        echo "--- Logs de msn-ai-app ---"
        docker logs msn-ai-app 2>&1 | tail -20 || echo "Contenedor no disponible"
        echo ""
        echo "--- Logs de msn-ai-ollama ---"
        docker logs msn-ai-ollama 2>&1 | tail -20 || echo "Contenedor no disponible"
        echo ""
        echo "--- Logs de msn-ai-setup ---"
        docker logs msn-ai-setup 2>&1 | tail -20 || echo "Contenedor no disponible"
        echo ""
        echo "üîç Para diagn√≥stico completo, ejecuta:"
        echo "   bash linux/docker-diagnostics.sh"
        exit 1
    fi

    echo "‚úÖ Contenedores Docker iniciados"
    echo ""

    # Show friendly message about ai-setup
    if docker ps -a --format '{{.Names}} {{.State.ExitCode}}' | grep -q "msn-ai-setup"; then
        SETUP_EXIT_CODE=$(docker inspect msn-ai-setup --format='{{.State.ExitCode}}' 2>/dev/null || echo "unknown")
        if [ "$SETUP_EXIT_CODE" = "0" ]; then
            echo "‚ÑπÔ∏è  Configuraci√≥n de IA: Completada exitosamente"
        else
            echo "‚ÑπÔ∏è  Configuraci√≥n de IA: Finalizada con advertencias (no cr√≠tico)"
            echo "   Los modelos de IA pueden instalarse manualmente"
        fi
        echo ""
    fi
}

# Function to wait for services
wait_for_services() {
    echo "‚è≥ Esperando que los servicios est√©n listos..."
    echo ""

    local max_attempts=60
    local attempt=1
    local ollama_ready=false
    local webapp_ready=false

    # First wait for Ollama
    echo "üîÑ Verificando servicio Ollama..."
    while [ $attempt -le $max_attempts ]; do
        if curl -s --max-time 2 http://localhost:11434/api/tags >/dev/null 2>&1; then
            echo "‚úÖ Ollama est√° listo (intento $attempt/$max_attempts)"
            ollama_ready=true
            break
        fi

        if [ $((attempt % 5)) -eq 0 ]; then
            echo "‚è≥ Esperando Ollama... intento $attempt/$max_attempts"
            # Show container status
            docker ps --filter name=msn-ai-ollama --format "   Estado: {{.Status}}"
        fi

        sleep 2
        attempt=$((attempt + 1))
    done

    if [ "$ollama_ready" = false ]; then
        echo "‚ö†Ô∏è  Ollama no respondi√≥ despu√©s de $((max_attempts * 2)) segundos"
        echo "   Logs de Ollama:"
        docker logs --tail 30 msn-ai-ollama
        echo ""
    fi

    # Then wait for web app
    echo "üîÑ Verificando aplicaci√≥n web MSN-AI..."
    attempt=1
    while [ $attempt -le $max_attempts ]; do
        if curl -s --max-time 2 http://localhost:8000/msn-ai.html >/dev/null 2>&1; then
            echo "‚úÖ MSN-AI est√° listo (intento $attempt/$max_attempts)"
            webapp_ready=true
            break
        fi

        if [ $((attempt % 5)) -eq 0 ]; then
            echo "‚è≥ Esperando MSN-AI Web... intento $attempt/$max_attempts"
            # Show container status
            docker ps --filter name=msn-ai-app --format "   Estado: {{.Status}}"
        fi

        sleep 2
        attempt=$((attempt + 1))
    done

    echo ""

    if [ "$webapp_ready" = false ]; then
        echo "‚ö†Ô∏è  MSN-AI Web no respondi√≥ despu√©s de $((max_attempts * 2)) segundos"
        echo ""
        echo "üìã Estado de contenedores:"
        $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps
        echo ""
        echo "üìù Logs recientes de MSN-AI App:"
        docker logs --tail 30 msn-ai-app 2>&1 || echo "El contenedor msn-ai-app no se inici√≥ correctamente"
        echo ""
        echo "üí° Posibles causas:"
        echo "   1. El contenedor a√∫n est√° iniciando (espera 1-2 minutos m√°s)"
        echo "   2. Falta de recursos del sistema (RAM/CPU)"
        echo "   3. Error en la construcci√≥n de la imagen"
        echo ""
        echo "üîç Para ver todos los logs:"
        echo "   $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml logs"
        echo ""
        echo "üîç Para diagn√≥stico completo:"
        echo "   bash linux/docker-diagnostics.sh"
        echo ""
        return 1
    fi

    return 0
}

# Function to open application
open_application() {
    echo "üåê Abriendo MSN-AI en el navegador..."

    # Try different browsers
    if command -v firefox >/dev/null 2>&1; then
        firefox http://localhost:8000/msn-ai.html &
    elif command -v google-chrome >/dev/null 2>&1; then
        google-chrome http://localhost:8000/msn-ai.html &
    elif command -v chromium-browser >/dev/null 2>&1; then
        chromium-browser http://localhost:8000/msn-ai.html &
    else
        echo "üåê Abre manualmente: http://localhost:8000/msn-ai.html"
    fi
}

# Function to show status and logs

show_status() {
    echo ""
    echo "üéâ ¬°MSN-AI Docker est√° ejecut√°ndose!"
    echo "===================================="

    # Detect server IP for information only
    SERVER_IP=$(hostname -I | awk '{print $1}' 2>/dev/null || echo "localhost")

    # Test connectivity
    echo "üß™ Verificando conectividad..."
    sleep 3

    echo -n "   üåê MSN-AI Web (localhost:8000): "
    if curl -s --connect-timeout 5 "http://localhost:8000/msn-ai.html" >/dev/null 2>&1; then
        echo "‚úÖ OK"
        WEB_OK=true
    else
        echo "‚ùå FALLA"
        WEB_OK=false
    fi

    echo -n "   ü§ñ Ollama API (localhost:11434): "
    if curl -s --connect-timeout 5 "http://localhost:11434/api/tags" >/dev/null 2>&1; then
        MODELS_RESPONSE=$(curl -s "http://localhost:11434/api/tags" 2>/dev/null)
        MODEL_COUNT=$(echo "$MODELS_RESPONSE" | grep -o '"name"' | wc -l 2>/dev/null || echo "0")
        echo "‚úÖ OK ($MODEL_COUNT modelos)"
        API_OK=true
    else
        echo "‚ùå FALLA"
        API_OK=false
    fi

    echo ""
    echo "üîó URLs DE ACCESO:"
    if [ "$WEB_OK" = true ]; then
        echo "   üè† Local:  http://localhost:8000/msn-ai.html"
        if [ "$SERVER_IP" != "localhost" ]; then
            echo "   üåê Remoto: http://$SERVER_IP:8000/msn-ai.html"
        fi
    fi

    if [ "$WEB_OK" = true ] && [ "$API_OK" = true ]; then
        echo ""
        echo "‚úÖ MSN-AI COMPLETAMENTE FUNCIONAL"
        echo "   ‚Ä¢ Interfaz web accesible"
        echo "   ‚Ä¢ API Ollama respondiendo"
        echo "   ‚Ä¢ $MODEL_COUNT modelos disponibles"
        echo "   ‚Ä¢ Auto-detecci√≥n de configuraci√≥n habilitada"
        echo "   ‚Ä¢ Sin configuraci√≥n de firewall requerida"
    elif [ "$WEB_OK" = true ]; then
        echo ""
        echo "‚ö†Ô∏è  MSN-AI PARCIALMENTE FUNCIONAL"
        echo "   ‚Ä¢ Interfaz web: ‚úÖ Accesible"
        echo "   ‚Ä¢ API Ollama: ‚ùå No responde"
        echo "   üí° Ver logs: docker logs msn-ai-ollama"
    else
        echo ""
        echo "‚ùå MSN-AI CON PROBLEMAS"
        echo "   ‚Ä¢ Interfaz web: ‚ùå No accesible"
        echo "   ‚Ä¢ API Ollama: ‚ùå No responde"
        echo "   üí° Ver logs: docker logs msn-ai-app"
    fi

    echo ""
    echo "üê≥ Contenedores:"
    $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps
    echo ""
    echo "üìä Estado de servicios:"
    $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps
    echo ""
    echo "üí° Comandos √∫tiles:"
    echo "   üîç Ver logs:        $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml logs -f"
    echo "   ‚èπÔ∏è  Detener:         $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml down"
    echo "   üîÑ Reiniciar:       $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml restart"
    echo "   üìä Estado:          $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml ps"
    echo ""
    echo "‚ö†Ô∏è  DETENCI√ìN CORRECTA:"
    echo "   $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml down"
    echo ""
    echo "üîß Datos persistentes en volumes de Docker"
    echo "üìß Soporte: alan.mac.arthur.garcia.diaz@gmail.com"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "‚òÅÔ∏è  MODELOS CLOUD DISPONIBLES"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "Los siguientes modelos cloud requieren autenticaci√≥n:"
    echo "  üì¶ qwen3-vl:235b-cloud"
    echo "  üì¶ gpt-oss:120b-cloud"
    echo "  üì¶ qwen3-coder:480b-cloud"
    echo ""
    echo "‚ö†Ô∏è  Los modelos cloud NO se instalan autom√°ticamente"
    echo ""
    echo "üìã Para instalar modelos cloud:"
    echo ""
    echo "1Ô∏è‚É£  Accede al contenedor:"
    echo "   docker exec -it msn-ai-ollama /bin/bash"
    echo ""
    echo "2Ô∏è‚É£  Haz signin (abre el enlace generado en tu navegador):"
    echo "   ollama signin"
    echo ""
    echo "3Ô∏è‚É£  Instala los modelos que necesites:"
    echo "   ollama pull qwen3-vl:235b-cloud"
    echo "   ollama pull gpt-oss:120b-cloud"
    echo "   ollama pull qwen3-coder:480b-cloud"
    echo ""
    echo "4Ô∏è‚É£  Verifica la instalaci√≥n:"
    echo "   ollama list"
    echo ""
    echo "5Ô∏è‚É£  Sal del contenedor:"
    echo "   exit"
    echo ""
    echo "üí° Los modelos locales ya est√°n instalados y funcionando"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
}

# Function for cleanup
cleanup() {
    echo ""
    echo "üßπ Deteniendo contenedores MSN-AI..."
    if [ -n "$DOCKER_COMPOSE_CMD" ]; then
        $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml down
    else
        # Fallback si no se pudo determinar el comando
        if command -v docker-compose &> /dev/null; then
            docker-compose -f docker/docker-compose.yml down
        elif docker compose version &> /dev/null 2>&1; then
            docker compose -f docker/docker-compose.yml down
        fi
    fi
    echo "‚úÖ Contenedores detenidos correctamente"
    echo "üëã ¬°Gracias por usar MSN-AI v2.1.0!"
    exit 0
}

# Trap signals for cleanup
trap cleanup SIGINT SIGTERM

# Main execution flow
main() {
    echo "üöÄ Iniciando MSN-AI en modo Docker..."

    # Check Docker installation
    check_docker

    # Check port conflicts
    check_port_conflicts

    # Check GPU support
    check_gpu_support

    # Setup environment
    setup_environment

    # Start containers
    start_containers

    # Wait for services
    wait_for_services

    # Open application (if not --no-browser flag)
    if [ "$1" != "--no-browser" ]; then
        open_application
    fi

    # Show status
    show_status

    # Keep script running for signal handling
    if [ "$1" = "--daemon" ]; then
        echo "üîÑ Modo daemon activado. Presiona Ctrl+C para detener."
        while true; do
            sleep 1
        done
    else
        echo "üí° Script completado. Los contenedores contin√∫an ejecut√°ndose."
        echo "   Para detenerlos: $DOCKER_COMPOSE_CMD -f docker/docker-compose.yml down"
    fi
}

# Parse command line arguments
case "$1" in
    --help|-h)
        echo "MSN-AI Docker - Opciones de uso:"
        echo ""
        echo "  $0                    Iniciar con navegador autom√°tico"
        echo "  $0 --no-browser      Iniciar sin abrir navegador"
        echo "  $0 --daemon          Mantener script activo"
        echo "  $0 --help            Mostrar esta ayuda"
        echo ""
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac
