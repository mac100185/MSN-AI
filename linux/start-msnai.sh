#!/bin/bash
# Script de inicio r√°pido para MSN-AI
# Versi√≥n: 1.0.0
# Autor: Alan Mac-Arthur Garc√≠a D√≠az
# Email: alan.mac.arthur.garcia.diaz@gmail.com
# Licencia: GNU General Public License v3.0
# Descripci√≥n: Inicia MSN-AI con verificaciones autom√°ticas

echo "üöÄ MSN-AI v1.0.0 - Iniciando aplicaci√≥n..."
echo "============================================"
echo "üìß Desarrollado por: Alan Mac-Arthur Garc√≠a D√≠az"
echo "‚öñÔ∏è Licencia: GPL-3.0 | üîó alan.mac.arthur.garcia.diaz@gmail.com"
echo "============================================"

# Detect and change to project root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "üîç Detectando directorio del proyecto..."
echo "   Script ubicado en: $SCRIPT_DIR"
echo "   Directorio ra√≠z: $PROJECT_ROOT"

# Change to project root
cd "$PROJECT_ROOT" || {
    echo "‚ùå Error: No se pudo cambiar al directorio del proyecto"
    echo "   Ruta intentada: $PROJECT_ROOT"
    exit 1
}

echo "   Directorio actual: $(pwd)"

# Verify we're in the correct directory
if [ ! -f "msn-ai.html" ]; then
    echo "‚ùå Error: No se encuentra msn-ai.html en $(pwd)"
    echo "   Archivos encontrados:"
    ls -la | head -10
    echo ""
    echo "üí° Aseg√∫rate de ejecutar este script desde:"
    echo "   $PROJECT_ROOT/linux/start-msnai.sh"
    exit 1
fi

echo "‚úÖ Proyecto MSN-AI detectado correctamente"
echo ""

# Funci√≥n para verificar Ollama
check_ollama() {
    echo "üîç Verificando Ollama..."

    if ! command -v ollama &> /dev/null; then
        echo "‚ö†Ô∏è  Ollama no est√° instalado"
        echo "   ¬øDeseas instalarlo autom√°ticamente? (s/n)"
        read -r install_ollama

        if [[ "$install_ollama" =~ ^[sS]$ ]]; then
            echo "üì¶ Instalando Ollama..."
            curl -fsSL https://ollama.com/install.sh | sh

            if [ $? -eq 0 ]; then
                echo "‚úÖ Ollama instalado correctamente"
            else
                echo "‚ùå Error instalando Ollama"
                exit 1
            fi
        else
            echo "‚è≠Ô∏è  Continuando sin Ollama (funcionalidad limitada)"
            return 1
        fi
    fi

    # Verificar si Ollama est√° ejecut√°ndose
    if ! pgrep -x "ollama" > /dev/null; then
        echo "üîÑ Iniciando Ollama..."
        ollama serve &
        OLLAMA_PID=$!
        sleep 3

        if pgrep -x "ollama" > /dev/null; then
            echo "‚úÖ Ollama iniciado correctamente (PID: $OLLAMA_PID)"
        else
            echo "‚ùå Error iniciando Ollama"
            return 1
        fi
    else
        echo "‚úÖ Ollama ya est√° ejecut√°ndose"
    fi

    # Verificar modelos disponibles
    echo "üß† Verificando modelos de IA..."
    MODELS=$(ollama list 2>/dev/null | tail -n +2 | wc -l)

    # Modelos requeridos por defecto
    REQUIRED_MODELS=(
        "qwen3-vl:235b-cloud"
        "gpt-oss:120b-cloud"
        "qwen3-coder:480b-cloud"
    )

    if [ "$MODELS" -eq 0 ]; then
        echo "‚ö†Ô∏è  No hay modelos instalados"
        echo ""
        echo "üì¶ Modelos requeridos por defecto:"
        for model in "${REQUIRED_MODELS[@]}"; do
            echo "   - $model"
        done
        echo ""
        echo "   ¬øDeseas instalar los modelos requeridos? (s/n)"
        read -r install_models

        if [[ "$install_models" =~ ^[sS]$ ]]; then
            echo ""
            echo "üì• Instalando modelos requeridos..."
            echo "‚ö†Ô∏è  NOTA: Este proceso puede tardar bastante tiempo dependiendo de tu conexi√≥n"
            echo ""

            local installed_count=0
            local failed_count=0

            for model in "${REQUIRED_MODELS[@]}"; do
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "üì• Descargando: $model"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                ollama pull "$model"

                if [ $? -eq 0 ]; then
                    echo "‚úÖ Modelo $model instalado correctamente"
                    installed_count=$((installed_count + 1))
                else
                    echo "‚ùå Error instalando modelo $model"
                    failed_count=$((failed_count + 1))
                fi
                echo ""
            done

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üìä Resumen de instalaci√≥n:"
            echo "   ‚úÖ Instalados: $installed_count/${#REQUIRED_MODELS[@]}"
            echo "   ‚ùå Fallidos: $failed_count/${#REQUIRED_MODELS[@]}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            if [ $installed_count -eq 0 ]; then
                echo "‚ùå No se pudo instalar ning√∫n modelo"
                return 1
            fi
        else
            echo "‚è≠Ô∏è  Continuando sin modelos (funcionalidad limitada)"
        fi
    else
        echo "‚úÖ Modelos disponibles: $MODELS"
        ollama list | head -n 10
    fi

    return 0
}

# Funci√≥n para detectar navegador
detect_browser() {
    echo "üåê Detectando navegador por defecto del sistema..."

    # Detectar SO
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux - Contar navegadores disponibles
        FOUND_BROWSERS=0

        if command -v firefox &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            FIRST_BROWSER="firefox"
        fi

        if command -v microsoft-edge &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            [ -z "$FIRST_BROWSER" ] && FIRST_BROWSER="microsoft-edge"
        fi

        if command -v microsoft-edge-stable &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            [ -z "$FIRST_BROWSER" ] && FIRST_BROWSER="microsoft-edge-stable"
        fi

        if command -v google-chrome &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            [ -z "$FIRST_BROWSER" ] && FIRST_BROWSER="google-chrome"
        fi

        if command -v chromium-browser &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            [ -z "$FIRST_BROWSER" ] && FIRST_BROWSER="chromium-browser"
        fi

        if command -v google-chrome-stable &> /dev/null; then
            FOUND_BROWSERS=$((FOUND_BROWSERS + 1))
            [ -z "$FIRST_BROWSER" ] && FIRST_BROWSER="google-chrome-stable"
        fi

        # Si hay m√∫ltiples navegadores, usar el navegador por defecto
        if [ $FOUND_BROWSERS -gt 1 ]; then
            echo "‚úÖ M√∫ltiples navegadores detectados. Usando navegador por defecto del sistema"
            BROWSER="xdg-open"
        elif [ $FOUND_BROWSERS -eq 1 ]; then
            echo "‚úÖ Navegador detectado: $FIRST_BROWSER"
            BROWSER="$FIRST_BROWSER"
        else
            echo "‚úÖ Usando navegador por defecto del sistema"
            BROWSER="xdg-open"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        BROWSER="open"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        # Windows
        BROWSER="start"
    else
        echo "‚ö†Ô∏è  Sistema operativo no detectado"
        BROWSER="xdg-open"
    fi
}

# Funci√≥n para iniciar servidor web local
start_server() {
    echo "üåç Iniciando servidor web local..."

    # Buscar puerto disponible
    PORT=8000
    while netstat -an 2>/dev/null | grep -q ":$PORT "; do
        PORT=$((PORT + 1))
        if [ $PORT -gt 8010 ]; then
            echo "‚ùå No se encontr√≥ puerto disponible"
            return 1
        fi
    done

    echo "üì° Servidor web en puerto: $PORT"

    # Intentar Python 3 primero, luego Python 2, luego Node.js
    if command -v python3 &> /dev/null; then
        echo "üêç Usando Python 3..."
        python3 -m http.server $PORT &
        SERVER_PID=$!
        SERVER_CMD="python3"
    elif command -v python &> /dev/null; then
        echo "üêç Usando Python 2..."
        python -m SimpleHTTPServer $PORT &
        SERVER_PID=$!
        SERVER_CMD="python"
    elif command -v node &> /dev/null && command -v npx &> /dev/null; then
        echo "üìó Usando Node.js..."
        npx http-server -p $PORT &
        SERVER_PID=$!
        SERVER_CMD="node"
    else
        echo "‚ö†Ô∏è  No se encontr√≥ servidor web disponible"
        echo "   Instalando python3-http-server simple..."

        # Crear servidor simple en bash (√∫ltimo recurso)
        echo "üîß Modo directo (sin servidor)"
        return 2
    fi

    if [ $? -eq 0 ]; then
        echo "‚úÖ Servidor iniciado (PID: $SERVER_PID)"
        echo "üîó URL: http://localhost:$PORT"

        # Esperar a que el servidor est√© listo
        sleep 2

        return 0
    else
        echo "‚ùå Error iniciando servidor"
        return 1
    fi
}

# Funci√≥n para abrir la aplicaci√≥n
open_app() {
    local url=$1
    local file_path=$2

    echo "üöÄ Abriendo MSN-AI..."

    if [ -n "$url" ]; then
        # Abrir URL del servidor
        if [ "$BROWSER" = "xdg-open" ] || [ "$BROWSER" = "open" ] || [ "$BROWSER" = "start" ]; then
            # Usar navegador por defecto del sistema
            $BROWSER "$url/msn-ai.html" &
        else
            # Usar navegador espec√≠fico detectado
            case $BROWSER in
                "firefox")
                    firefox "$url/msn-ai.html" &
                    ;;
                "microsoft-edge"|"microsoft-edge-stable")
                    $BROWSER --new-window "$url/msn-ai.html" &
                    ;;
                "google-chrome"|"google-chrome-stable")
                    $BROWSER --new-window "$url/msn-ai.html" &
                    ;;
                "chromium-browser")
                    chromium-browser --new-window "$url/msn-ai.html" &
                    ;;
                *)
                    $BROWSER "$url/msn-ai.html" &
                    ;;
            esac
        fi
    else
        # Abrir archivo directamente
        if [ "$BROWSER" = "xdg-open" ] || [ "$BROWSER" = "open" ] || [ "$BROWSER" = "start" ]; then
            # Usar navegador por defecto del sistema
            $BROWSER "file://$(pwd)/msn-ai.html" &
        else
            # Usar navegador espec√≠fico detectado
            case $BROWSER in
                "firefox")
                    firefox "file://$(pwd)/msn-ai.html" &
                    ;;
                "microsoft-edge"|"microsoft-edge-stable")
                    $BROWSER --new-window --allow-file-access-from-files "file://$(pwd)/msn-ai.html" &
                    ;;
                "google-chrome"|"google-chrome-stable")
                    $BROWSER --new-window --allow-file-access-from-files "file://$(pwd)/msn-ai.html" &
                    ;;
                "chromium-browser")
                    chromium-browser --new-window --allow-file-access-from-files "file://$(pwd)/msn-ai.html" &
                    ;;
                *)
                    $BROWSER "file://$(pwd)/msn-ai.html" &
                    ;;
            esac
        fi
    fi

    echo "‚úÖ MSN-AI abierto en el navegador"
}

# Funci√≥n de limpieza al salir
cleanup() {
    echo ""
    echo "üßπ Limpiando procesos MSN-AI..."
    echo "‚ö†Ô∏è IMPORTANTE: No fuerces el cierre, espera la limpieza completa"

    # Detener servidor web
    if [ -n "$SERVER_PID" ] && kill -0 $SERVER_PID 2>/dev/null; then
        echo "üõë Deteniendo servidor web (PID: $SERVER_PID)..."
        kill $SERVER_PID 2>/dev/null
        sleep 1
        if kill -0 $SERVER_PID 2>/dev/null; then
            echo "‚ö†Ô∏è Forzando cierre del servidor..."
            kill -9 $SERVER_PID 2>/dev/null
        fi
    fi

    # Detener Ollama solo si fue iniciado por este script
    if [ -n "$OLLAMA_PID" ] && kill -0 $OLLAMA_PID 2>/dev/null; then
        echo "üõë Deteniendo Ollama (PID: $OLLAMA_PID)..."
        kill $OLLAMA_PID 2>/dev/null
        sleep 2
        if kill -0 $OLLAMA_PID 2>/dev/null; then
            echo "‚ö†Ô∏è Forzando cierre de Ollama..."
            kill -9 $OLLAMA_PID 2>/dev/null
        fi
    fi

    # Verificar que todo est√© limpio
    echo "üîç Verificando limpieza..."
    if pgrep -f "python.*http.server" >/dev/null 2>&1; then
        echo "‚ö†Ô∏è Limpiando servidores Python restantes..."
        pkill -f "python.*http.server" 2>/dev/null
    fi

    echo "‚úÖ Limpieza completada exitosamente"
    echo "üëã ¬°Gracias por usar MSN-AI v1.0.0!"
    echo "üìß Reporta problemas a: alan.mac.arthur.garcia.diaz@gmail.com"
    exit 0
}

# Capturar se√±ales para limpieza
trap cleanup SIGINT SIGTERM

# ===================
# FLUJO PRINCIPAL
# ===================

echo "üìã Iniciando verificaciones..."

# 1. Verificar Ollama (opcional pero recomendado)
check_ollama
OLLAMA_OK=$?

# 2. Detectar navegador
detect_browser

# 3. Decidir m√©todo de apertura
echo "ü§î Seleccionando m√©todo de inicio..."
echo "   1) Servidor local (recomendado)"
echo "   2) Archivo directo (puede tener limitaciones)"
echo "   3) Solo verificar sistema"
echo ""

# Auto-seleccionar o pedir al usuario
if [ "$1" = "--auto" ] || [ "$1" = "-a" ]; then
    echo "üîÑ Modo autom√°tico seleccionado"
    METHOD=1
else
    echo "Selecciona una opci√≥n (1-3) o presiona Enter para autom√°tico: "
    read -r METHOD

    if [ -z "$METHOD" ]; then
        METHOD=1
    fi
fi

case $METHOD in
    1)
        echo "üì° Iniciando con servidor local..."
        start_server
        SERVER_STATUS=$?

        if [ $SERVER_STATUS -eq 0 ]; then
            open_app "http://localhost:$PORT" ""

            echo ""
            echo "üéâ ¬°MSN-AI v1.0.0 est√° ejecut√°ndose!"
            echo "============================================"
            echo "üì± URL: http://localhost:$PORT/msn-ai.html"
            echo "üîß Ollama: $([ $OLLAMA_OK -eq 0 ] && echo "‚úÖ Funcionando" || echo "‚ö†Ô∏è No disponible")"
            echo "üåê Navegador: $BROWSER"
            echo "üìß Desarrollador: Alan Mac-Arthur Garc√≠a D√≠az"
            echo ""
            echo "üí° Consejos importantes:"
            echo "   ‚Ä¢ Mant√©n esta terminal abierta mientras usas MSN-AI"
            echo "   ‚Ä¢ Presiona Ctrl+C para detener CORRECTAMENTE"
            echo "   ‚Ä¢ NUNCA cierres la terminal sin Ctrl+C"
            echo "   ‚Ä¢ NUNCA uses kill -9 directamente"
            echo "   ‚Ä¢ Verifica la conexi√≥n con Ollama en la app"
            echo ""
            echo "‚ö†Ô∏è DETENCI√ìN SEGURA:"
            echo "   1. Presiona Ctrl+C en esta terminal"
            echo "   2. Espera el mensaje de limpieza completa"
            echo "   3. No fuerces el cierre hasta ver: '‚úÖ Limpieza completada'"
            echo ""
            echo "‚è≥ Servidor activo... Ctrl+C para detener correctamente"

            # Mantener servidor activo
            while true; do
                sleep 1
                if ! kill -0 $SERVER_PID 2>/dev/null; then
                    echo "‚ö†Ô∏è Servidor web se detuvo inesperadamente"
                    break
                fi
            done
        else
            echo "‚ö†Ô∏è Error con servidor, intentando modo directo..."
            open_app "" "$(pwd)/msn-ai.html"
        fi
        ;;

    2)
        echo "üìÅ Abriendo archivo directo..."
        open_app "" "$(pwd)/msn-ai.html"

        echo ""
        echo "üéâ ¬°MSN-AI v1.0.0 abierto!"
        echo "============================================"
        echo "‚ö†Ô∏è  Modo archivo directo (funcionalidad limitada)"
        echo "üîß Ollama: $([ $OLLAMA_OK -eq 0 ] && echo "‚úÖ Funcionando" || echo "‚ö†Ô∏è No disponible")"
        echo "üìß Soporte: alan.mac.arthur.garcia.diaz@gmail.com"
        echo ""
        echo "üí° Si experimentas problemas, usa el modo servidor (opci√≥n 1)"
        echo "‚ö†Ô∏è En este modo no hay procesos que detener manualmente"
        ;;

    3)
        echo "üîç Solo verificaci√≥n del sistema:"
        echo "============================================"
        echo "‚úÖ MSN-AI: Archivo encontrado"
        echo "üîß Ollama: $([ $OLLAMA_OK -eq 0 ] && echo "‚úÖ Funcionando" || echo "‚ùå No disponible")"
        echo "üåê Navegador: $BROWSER detectado"
        echo "üìß Desarrollador: Alan Mac-Arthur Garc√≠a D√≠az"
        echo "‚öñÔ∏è Licencia: GPL-3.0"
        echo ""
        echo "üí° Para iniciar la aplicaci√≥n:"
        echo "   $0 --auto"
        echo ""
        echo "üí° Para detener correctamente (cuando est√© ejecut√°ndose):"
        echo "   Ctrl+C en la terminal del servidor"
        ;;

    *)
        echo "‚ùå Opci√≥n no v√°lida"
        exit 1
        ;;
esac

echo ""
echo "üèÅ MSN-AI v1.0.0 - Script completado"
echo "üìß ¬øProblemas? Contacta: alan.mac.arthur.garcia.diaz@gmail.com"
echo "‚öñÔ∏è Software libre bajo GPL-3.0"
